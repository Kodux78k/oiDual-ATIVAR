<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Dual Infodose — KOBLLUX OS</title>
  <meta name="theme-color" content="#050714"/>
  <link rel="manifest" href="./manifest.json">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<!-- Apple Touch Icon -->
<link rel="apple-touch-icon" sizes="180x180" href="./icon-192.png">
<script> if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js') .then(() => console.log('Service Worker Registered')); } </script>
<!-- Ícone 192x192 -->
<link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
  <style>
    /* ---------- VARIABLES & RESET ---------- */
    :root {
      --bg-dark: #02040a;
      --bg-gradient: radial-gradient(circle at 50% -10%, #1a224f 0%, #050714 60%, #000 100%);
      
      /* Cores Dinâmicas */
      --accent-main: #00f6ff;
      --accent-glow: rgba(0, 246, 255, 0.4);
      --accent2: #ff00f0;
      
      /* Sistema de Vidro (Glassmorphism) */
      --glass-surface: rgba(18, 22, 40, 0.65);
      --glass-border: rgba(255, 255, 255, 0.08);
      --glass-highlight: rgba(255, 255, 255, 0.03);
      --blur-amt: 16px;
      
      --text-main: #f0f2f5;
      --text-muted: rgba(255, 255, 255, 0.5);
      
      --radius-lg: 24px;
      --radius-md: 16px;
      --radius-sm: 10px;
      
      --orb-size: 68px;
      --ease-out: cubic-bezier(0.23, 1, 0.32, 1);
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg-dark);
      background-image: var(--bg-gradient);
      background-attachment: fixed;
      color: var(--text-main);
      overflow-x: hidden;
      font-size: 15px;
    }

    /* Scrollbar estilizada */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

    /* ---------- SHELL / SPLASH ---------- */
    #splash-screen {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      background: #030407;
      gap: 20px;
      padding: 30px;
      transition: opacity 0.8s ease, visibility 0.8s;
    }
    
    #splash-screen::before {
      content: '';
      position: absolute;
      width: 100%; height: 100%;
      background: radial-gradient(circle at center, rgba(0, 246, 255, 0.05), transparent 70%);
      pointer-events: none;
    }

    #splash-screen.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .splash-logo {
      font-size: 32px;
      font-weight: 800;
      letter-spacing: -1px;
      background: linear-gradient(135deg, #fff 0%, var(--accent-main) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
      text-shadow: 0 0 30px var(--accent-glow);
    }

    .splash-input {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--glass-border);
      padding: 14px 20px;
      border-radius: var(--radius-md);
      color: #fff;
      width: 100%;
      max-width: 300px;
      text-align: center;
      font-size: 16px;
      transition: 0.3s;
    }
    .splash-input:focus {
      border-color: var(--accent-main);
      box-shadow: 0 0 15px var(--accent-glow);
      background: rgba(0,0,0,0.3);
    }

    .splash-btn {
      background: var(--accent-main);
      color: #000;
      padding: 14px 28px;
      border-radius: 50px;
      border: none;
      cursor: pointer;
      font-weight: 700;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 4px 20px var(--accent-glow);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .splash-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 30px var(--accent-glow);
    }

    /* ---------- MAIN LAYOUT ---------- */
    .shell {
      width: 100%;
      max-width: 1024px;
      margin: 0 auto;
      padding: 24px 20px 100px 20px; /* Padding bottom para o FAB */
      display: flex;
      flex-direction: column;
      gap: 24px;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.8s var(--ease-out) 0.2s, transform 0.8s var(--ease-out) 0.2s;
    }
    .shell.visible { opacity: 1; transform: translateY(0); }

    @media (min-width: 768px) {
      .shell { margin-top: 40px; }
      header { margin-bottom: 10px; }
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 4px;
    }

    .logo-title {
      display: flex;
      flex-direction: column;
      line-height: 1.2;
    }
    .logo-title span:first-child {
      font-size: 11px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--accent-main);
      font-weight: 700;
      opacity: 0.9;
    }
    .logo-title span:last-child {
      font-size: 20px;
      color: #fff;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    /* ---------- CARDS & GLASS ---------- */
    .player-card, .action-card, .card, .modal-overlay, .sidebar-panel {
      background: var(--glass-surface);
      backdrop-filter: blur(var(--blur-amt));
      -webkit-backdrop-filter: blur(var(--blur-amt));
      border: 1px solid var(--glass-border);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), inset 0 0 0 1px var(--glass-highlight);
    }

    .player-card {
      border-radius: var(--radius-lg);
      padding: 24px;
      position: relative;
      overflow: hidden;
      transition: border-color 0.3s;
    }
    
    /* Brilho ambiental no card principal */
    .player-card::after {
      content: '';
      position: absolute;
      top: -50%; left: -50%;
      width: 200%; height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.03) 0%, transparent 60%);
      pointer-events: none;
      z-index: 0;
    }

    /* ---------- VISUALIZER ---------- */
    .screen-mock {
      width: 100%;
      height: 140px;
      background: #000;
      border-radius: var(--radius-md);
      margin: 20px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: inset 0 0 20px rgba(0,0,0,1);
      overflow: hidden;
      z-index: 1;
    }
    
    /* Efeito de Scanline */
    .screen-mock::before {
      content: '';
      position: absolute; inset: 0;
      background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0, 246, 255, 0.03) 3px);
      pointer-events: none;
      z-index: 2;
    }

    .voice-spectrum {
      display: flex;
      align-items: flex-end;
      gap: 6px;
      height: 60px;
      z-index: 3;
    }
    .bar {
      width: 6px;
      background: var(--accent-main);
      border-radius: 4px;
      height: 6px;
      transition: height 0.1s ease;
      box-shadow: 0 0 10px var(--accent-main);
    }
    .voice-spectrum.active .bar { animation: wave 1s ease-in-out infinite; }
    .voice-spectrum.active .bar:nth-child(1) { animation-delay: 0.1s; }
    .voice-spectrum.active .bar:nth-child(2) { animation-delay: 0.2s; }
    .voice-spectrum.active .bar:nth-child(3) { animation-delay: 0.3s; }
    .voice-spectrum.active .bar:nth-child(4) { animation-delay: 0.2s; }
    .voice-spectrum.active .bar:nth-child(5) { animation-delay: 0.1s; }

    @keyframes wave { 
      0%, 100% { height: 8px; opacity: 0.5; } 
      50% { height: 50px; opacity: 1; } 
    }

    /* ---------- TYPOGRAPHY CONTENT ---------- */
    .arch-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
      background: linear-gradient(90deg, #fff, rgba(255,255,255,0.7));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .arch-mantra {
      font-size: 15px;
      color: var(--accent-main);
      font-style: italic;
      margin-bottom: 8px;
      text-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    .arch-shadow {
        color: var(--text-muted);
        font-size: 13px;
    }

    /* ---------- BUTTONS ---------- */
    .cta-btn {
      background: var(--accent-main);
      color: #03040a;
      border: none;
      padding: 12px 20px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 700;
      font-size: 14px;
      transition: all 0.2s;
      box-shadow: 0 0 15px var(--accent-glow);
    }
    .cta-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 25px var(--accent-glow);
    }

    .ghost {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--glass-border);
      color: var(--text-main);
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    .ghost:hover {
      background: rgba(255,255,255,0.08);
      border-color: rgba(255,255,255,0.2);
    }
    
    .primary {
      background: var(--accent-main);
      color: #000;
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      border: none;
      font-weight: 700;
      cursor: pointer;
    }

    /* ---------- GRID LAYOUTS ---------- */
    .content-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    @media(min-width: 900px){
      .content-grid { grid-template-columns: 1fr 340px; }
    }

    .sidebar-panel {
      padding: 20px;
      border-radius: var(--radius-md);
    }

    .grid-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .card {
      padding: 16px;
      border-radius: var(--radius-md);
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: transform 0.2s, border-color 0.2s;
    }
    .card:hover {
      transform: translateY(-2px);
      border-color: rgba(255,255,255,0.2);
    }
    .card h3 { margin: 0; font-size: 16px; color: #fff; }
    .card p { margin: 0; color: var(--text-muted); font-size: 13px; line-height: 1.4; }

    /* ---------- INPUTS ---------- */
    input[type="text"], input[type="url"], textarea {
      background: rgba(0,0,0,0.2);
      border: 1px solid var(--glass-border);
      padding: 12px;
      border-radius: var(--radius-sm);
      color: #fff;
      width: 100%;
      font-family: inherit;
      transition: 0.2s;
    }
    input:focus {
      border-color: var(--accent-main);
      background: rgba(0,0,0,0.4);
    }
    label.small {
      display: block;
      margin-bottom: 6px;
      color: var(--accent-main);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 700;
    }

    /* ---------- FAB / ORB ---------- */
    #fab {
      position: fixed;
      right: 24px;
      bottom: 24px;
      z-index: 120;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 12px;
    }
    
    #orb2d {
      width: var(--orb-size);
      height: var(--orb-size);
      border-radius: 50%;
      cursor: pointer;
      background: conic-gradient(from 180deg, var(--accent2), var(--accent-main), var(--accent2));
      box-shadow: 0 0 30px rgba(0, 246, 255, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #000;
      font-size: 24px;
      position: relative;
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 2;
    }
    
    #orb2d::before {
      content: ''; position: absolute; inset: 3px;
      background: #000; border-radius: 50%;
      z-index: -1;
    }
    #orb2d:hover { transform: scale(1.1) rotate(90deg); }
    #orb2d:active { transform: scale(0.95); }

    #orb-picker {
      opacity: 0;
      transform: translateY(20px) scale(0.9);
      pointer-events: none;
      max-height: 340px;
      overflow-y: auto;
      padding: 12px;
      background: rgba(5, 7, 20, 0.9);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      transition: all 0.3s var(--ease-out);
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }
    #fab.open #orb-picker {
      opacity: 1;
      transform: none;
      pointer-events: all;
    }

    .picker-chip {
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      padding: 10px 14px;
      border: 1px solid transparent;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: 0.2s;
    }
    .picker-chip:hover { background: rgba(255,255,255,0.08); }
    .picker-chip.active {
      border-color: var(--accent-main);
      background: rgba(0, 246, 255, 0.05);
      box-shadow: 0 0 15px rgba(0, 246, 255, 0.1) inset;
    }

    /* ---------- MODAL ---------- */
    .modal-overlay {
      position: fixed;
      inset: 20px;
      margin: auto;
      max-width: 700px;
      max-height: 80vh;
      border-radius: var(--radius-lg);
      z-index: 200;
      display: flex;
      flex-direction: column;
      padding: 24px;
      opacity: 0;
      pointer-events: none;
      transform: scale(0.95);
      transition: all 0.3s var(--ease-out);
      background: #0b0e1b; /* Fallback solid */
      background: rgba(11, 14, 27, 0.95);
    }
    
    /* Overlay backdrop scuro atrás do modal */
    .modal-overlay::before {
      content: '';
      position: fixed;
      top: -100vh; left: -100vw;
      width: 300vw; height: 300vh;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      z-index: -1;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    
    .modal-overlay.open { opacity: 1; pointer-events: all; transform: scale(1); }
    .modal-overlay.open::before { opacity: 1; pointer-events: all; }

    .doc-item {
      background: rgba(255,255,255,0.03);
      padding: 14px;
      border-radius: 12px;
      margin-bottom: 10px;
      border-left: 3px solid var(--accent-main);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      transition: background 0.2s;
    }
    .doc-item:hover { background: rgba(255,255,255,0.06); }

    /* ---------- FOOTER ---------- */
    footer {
      display: flex;
      justify-content: center;
      gap: 12px;
      padding: 20px;
      color: var(--text-muted);
      font-size: 11px;
      letter-spacing: 1px;
      opacity: 0.6;
    }

    /* ---------- UTILS ---------- */
    .small { font-size: 12px; color: var(--text-muted); }
    .text-right { text-align: right; }
    .flex-center { display: flex; align-items: center; }
    .flex-between { display: flex; justify-content: space-between; }
    
  </style>
</head>
<body>

  <div id="splash-screen" role="dialog" aria-label="Splash">
    <div class="splash-logo">Dual.Infodose</div>
    <input id="splash-name" class="splash-input" placeholder="IDENTIFICAÇÃO NEURAL" autocomplete="off" />
    <div style="display:flex; gap:12px; align-items:center;">
      <button class="splash-btn" onclick="initSystem()">Iniciar Link</button>
      <button id="prompt-install" class="ghost" style="display:none; border-radius:50px; padding:12px 20px;" onclick="promptInstall()">Install PWA</button>
    </div>
    <div class="small" style="margin-top:20px; opacity:0.5; letter-spacing:2px;">KOBLLUX ENGINE v2.5</div>
  </div>

  <main class="shell" id="main-shell" role="main" aria-live="polite">
    <header>
      <div class="logo-title">
        <span>Sincronia Ativa</span>
        <span>Dual.Infodose</span>
      </div>
      <div class="text-right">
        <div id="clock" style="font-family:monospace; font-size:16px; color:var(--accent-main)">00:00</div>
        <div id="play-status" class="small" style="letter-spacing:1px; margin-top:4px">AGUARDANDO</div>
      </div>
    </header>

    <section class="player-card" aria-label="Player">
      <div class="flex-between flex-center">
        <div id="user-welcome" class="small" style="text-transform:uppercase; letter-spacing:1px; font-weight:600;">Bem-vindo</div>
        <div id="status-pill" class="small" style="padding:4px 12px; border-radius:20px; background:rgba(255,255,255,0.05); font-weight:700;">PRONTO</div>
      </div>

      <div class="screen-mock" onclick="toggleSpeech()" title="Toque para ouvir o mantra" role="button" aria-pressed="false">
        <div class="voice-spectrum" id="spectrum" aria-hidden="true">
          <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
        </div>
        <div style="position:absolute; bottom:12px; font-size:10px; text-transform:uppercase; letter-spacing:1px; color:rgba(255,255,255,0.3);">Toque para Sincronizar</div>
      </div>

      <div>
        <div class="arch-title" id="ui-name">Carregando...</div>
        <div class="arch-mantra" id="ui-mantra">...</div>
        <div class="small arch-shadow" id="ui-shadow">...</div>
      </div>
    </section>

    <section class="content-grid">
      <div style="display:flex; flex-direction:column; gap:20px;">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="cta-btn" onclick="captureInfo()">Capturar Infodoc</button>
          <button class="ghost" onclick="openLibrary()">Biblioteca</button>
          <button class="ghost" onclick="openAddVideo()">+ Vídeo</button>
        </div>

        <div class="sidebar-panel">
          <div class="flex-between flex-center">
            <h3 style="margin:0; font-size:16px; font-weight:600; color:#fff;">Biblioteca Viva</h3>
            <span class="small" id="count-label">0</span>
          </div>
          <div id="live-cards" class="grid-cards"></div>
        </div>
      </div>

      <div class="sidebar-panel" style="height:fit-content;">
        <h3 style="margin-top:0; font-size:16px; margin-bottom:16px;">Configuração Neural</h3>
        
        <label class="small">Nome do Viajante</label>
        <input id="profile-name" type="text" placeholder="Como quer ser chamado?" />
        
        <label class="small" style="margin-top:16px">Assistente IA</label>
        <input id="profile-assistant" type="text" placeholder="Nome do assistente" />
        
        <div style="display:flex; gap:10px; margin-top:20px">
          <button class="primary" onclick="saveProfile()" style="flex:1">Ativar</button>
          <button class="ghost" onclick="clearProfile()">Limpar</button>
        </div>
      </div>
    </section>

    <footer>
      KODUX // DUAL.INFODOSE // SYSTEM 2025
    </footer>
  </main>

  <div id="fab" aria-hidden="false">
    <div id="orb-picker" aria-hidden="true"></div>
    <div id="orb2d" onclick="togglePicker()" title="Abrir picker de arquétipos" role="button">
      <div style="width:8px; height:8px; background:#000; border-radius:50%;"></div>
    </div>
  </div>

  <div id="lib-modal" class="modal-overlay" aria-hidden="true">
    <div class="flex-between flex-center" style="margin-bottom:16px;">
      <h3 style="margin:0; color:#fff; font-size:20px;">Memória Retida</h3>
      <button class="ghost" onclick="closeLibrary()" style="padding:6px 12px;">✕</button>
    </div>
    
    <div style="display:flex; gap:10px; margin-bottom:16px;">
      <button class="ghost" onclick="exportSession()" style="font-size:12px">Exportar JSON</button>
      <label class="ghost" style="cursor:pointer; font-size:12px"><input id="import-file" type="file" accept="application/json" style="display:none" onchange="importSession(event)"> Importar JSON</label>
    </div>

    <div id="lib-content" style="overflow-y:auto; flex:1; padding-right:4px;"></div>
    
    <div style="margin-top:20px; border-top:1px solid var(--glass-border); padding-top:16px;">
      <strong class="small" style="text-transform:uppercase; letter-spacing:1px; color:var(--accent-main)">Links de Vídeo</strong>
      <div id="video-list" style="margin-top:12px; max-height:150px; overflow-y:auto;"></div>
    </div>
  </div>

  <div id="addvideo-modal" class="modal-overlay" aria-hidden="true" style="display:none; max-width:500px; height:auto;">
    <div class="flex-between flex-center">
      <h3 style="margin:0; font-size:18px;">Adicionar Link</h3>
      <button class="ghost" onclick="closeAddVideo()" style="padding:4px 10px;">✕</button>
    </div>
    <div style="display:flex; flex-direction:column; gap:12px; margin-top:20px;">
      <input id="video-title" type="text" placeholder="Título (opcional)">
      <input id="video-url" type="url" placeholder="URL do YouTube">
      <div style="display:flex; gap:10px; margin-top:8px;">
        <button class="primary" onclick="saveVideo()" style="flex:1">Salvar</button>
        <button class="ghost" onclick="closeAddVideo()">Cancelar</button>
      </div>
    </div>
  </div>

<script>
/* -----------------------------
   Dual Infodose — Unified Expanded
   (Mesma lógica, com pequenas adaptações visuais se necessário)
   ----------------------------- */

(() => {
  // ---------- ARCHETYPES ----------
  const ARCHETYPES = [
    { id:'atlas', name:'Atlas', symbol:'(6_9)', mantra:'Eu ergo a base e inicio o caminho.', shadow:'Sombra: Sobrecarga (Mártir) ou Fuga.', voice:'Reed', rate:1.0, pitch:0.93, colorMain:'#38BDF8', colorSecondary:'#0EA5E9' },
    { id:'nova', name:'Nova', symbol:'(:_:)', mantra:'Eu expando com leveza e continuidade.', shadow:'Sombra: Dispersão e Falta de Foco.', voice:'Luciana', rate:1.06, pitch:1.1, colorMain:'#F97316', colorSecondary:'#FDBA74' },
    { id:'vitalis', name:'Vitalis', symbol:'(+_+)', mantra:'Eu ativo energia e movimento.', shadow:'Sombra: Impulsividade ou Agressividade.', voice:'Rocko', rate:0.96, pitch:1.2, colorMain:'#22C55E', colorSecondary:'#4ADE80' },
    { id:'pulse', name:'Pulse', symbol:'(~_~)', mantra:'Eu vibro no ritmo certo.', shadow:'Sombra: Ansiedade ou Apatia.', voice:'Reed', rate:1.0, pitch:1.14, colorMain:'#EC4899', colorSecondary:'#F9A8D4' },
    { id:'artemis', name:'Artemis', symbol:'(^_^) >-', mantra:'Eu foco e protejo o alvo.', shadow:'Sombra: Rigidez Cega ou Isolamento.', voice:'Luciana', rate:1.00, pitch:1.1, colorMain:'#A855F7', colorSecondary:'#C4B5FD' },
    { id:'serena', name:'Serena', symbol:'(\\' _\\')', mantra:'Eu acalmo e confio no caminho.', shadow:'Sombra: Passividade ou Negação.', voice:'Joana', rate:0.92, pitch:0.90, colorMain:'#7dd3fc', colorSecondary:'#E0F2FE' },
    { id:'kaos', name:'Kaos', symbol:'(!_!)', mantra:'Eu quebro e recrio com coragem.', shadow:'Sombra: Destruição sem propósito.', voice:'Rocko', rate:1.09, pitch:1.28, colorMain:'#FACC15', colorSecondary:'#FDE68A' },
    { id:'genus', name:'Genus', symbol:'=^=', mantra:'Eu projeto e construo com ordem.', shadow:'Sombra: Perfeccionismo paralisante.', voice:'Reed', rate:0.98, pitch:1.0, colorMain:'#9CA3AF', colorSecondary:'#E5E7EB' },
    { id:'lumine', name:'Lumine', symbol:'(o_o)', mantra:'Eu trago clareza simples e direta.', shadow:'Sombra: Superficialidade.', voice:'Luciana', rate:1.03, pitch:1.3, colorMain:'#FDE047', colorSecondary:'#FACC15' },
    { id:'solus', name:'Solus', symbol:'(O_O)', mantra:'Eu centro e acendo a luz interna.', shadow:'Sombra: Egoísmo ou Arrogância.', voice:'Luciana', rate:0.88, pitch:0.8, colorMain:'#0284c7', colorSecondary:'#0369A1' },
    { id:'aion', name:'Aion', symbol:'(8_8)', mantra:'Eu respiro o tempo e integro.', shadow:'Sombra: Procrastinação ou Nostalgia.', voice:'Monica', rate:0.98, pitch:1.00, colorMain:'#4F46E5', colorSecondary:'#818cf8' },
    { id:'kobllux', name:'KOBLLUX', symbol:'[K]', mantra:'Núcleo do sistema. Oracular.', shadow:'Sombra: Frio Absoluto.', voice:'Google', rate:0.90, pitch:0.8, colorMain:'#22D3EE', colorSecondary:'#06B6D4' }
  ];

  // ---------- STATE ----------
  const STORAGE_KEYS = {
    docs: 'dual_docs',
    videos: 'dual_videos',
    user: 'dual_user',
    assistant: 'dual_assistant'
  };

  let state = {
    activeArch: ARCHETYPES[0],
    docs: JSON.parse(localStorage.getItem(STORAGE_KEYS.docs) || '[]'),
    videos: JSON.parse(localStorage.getItem(STORAGE_KEYS.videos) || '[]'),
    userName: localStorage.getItem(STORAGE_KEYS.user) || '',
    assistantName: localStorage.getItem(STORAGE_KEYS.assistant) || '',
    isSpeaking: false
  };

  let synth = window.speechSynthesis;
  let utterance = null;
  let pickerOpen = false;
  let deferredPrompt = null;

  // ---------- HELPERS ----------
  function hexToRgba(hex, alpha=1){
    if(!hex) return `rgba(255,255,255,${alpha})`;
    hex = hex.replace('#','');
    if(hex.length===3) hex = hex.split('').map(c=>c+c).join('');
    const r = parseInt(hex.substring(0,2),16);
    const g = parseInt(hex.substring(2,4),16);
    const b = parseInt(hex.substring(4,6),16);
    return `rgba(${r},${g},${b},${alpha})`;
  }

  function saveState(){
    localStorage.setItem(STORAGE_KEYS.docs, JSON.stringify(state.docs));
    localStorage.setItem(STORAGE_KEYS.videos, JSON.stringify(state.videos));
    localStorage.setItem(STORAGE_KEYS.user, state.userName);
    localStorage.setItem(STORAGE_KEYS.assistant, state.assistantName);
    renderLibrary();
    renderVideos();
    renderLiveCards();
    updateLibraryUI();
  }

  function formatDate(d=new Date()){
    return d.toLocaleString('pt-BR');
  }

  // ---------- UI / THEME ----------
  function applyTheme(arch){
    const root = document.documentElement;
    root.style.setProperty('--accent-main', arch.colorMain);
    root.style.setProperty('--accent2', arch.colorSecondary);
    root.style.setProperty('--accent-glow', hexToRgba(arch.colorMain, 0.4));
    
    document.getElementById('ui-name') && (document.getElementById('ui-name').innerHTML = `${arch.symbol} ${arch.name}`);
    document.getElementById('ui-mantra') && (document.getElementById('ui-mantra').innerText = arch.mantra);
    document.getElementById('ui-shadow') && (document.getElementById('ui-shadow').innerText = arch.shadow);
    document.querySelectorAll('.picker-chip').forEach(c=>c.classList.remove('active'));
    const chip = document.querySelector(`.picker-chip[data-id="${arch.id}"]`);
    if(chip) chip.classList.add('active');
    state.activeArch = arch;
  }

  function buildPicker(){
    const container = document.getElementById('orb-picker');
    if(!container) return;
    container.innerHTML = '';
    ARCHETYPES.forEach(arch=>{
      const el = document.createElement('div');
      el.className='picker-chip';
      el.dataset.id = arch.id;
      el.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><div style="font-weight:700; font-size:13px">${arch.name}</div></div><div style="width:10px;height:10px;border-radius:50%;background:${arch.colorMain};box-shadow:0 0 8px ${arch.colorMain}"></div>`;
      el.onclick = (e) => { e.stopPropagation(); applyTheme(arch); shortBeep(arch.name); updateLiveCardsHighlight(); };
      container.appendChild(el);
    });
  }

  function shortBeep(text){
    if(!synth) return;
    const u = new SpeechSynthesisUtterance(text);
    u.volume = 0.25; u.rate = 1.4; u.pitch = 1.6;
    synth.speak(u);
  }

  // ---------- TTS ----------
  function ensureVoices(callback){
    let voices = synth.getVoices();
    if(voices.length>0) return callback(voices);
    synth.onvoiceschanged = () => callback(synth.getVoices());
  }

  window.toggleSpeech = function(){
    if(state.isSpeaking){
      synth.cancel();
      state.isSpeaking = false;
      updatePlayState(false);
      return;
    }
    const arch = state.activeArch;
    const text = `${arch.mantra} ... Atenção: ${arch.shadow}`;
    utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'pt-BR';
    ensureVoices((voices)=>{
      let v = voices.find(x => x.name && x.name.toLowerCase().includes((arch.voice||'').toLowerCase()));
      if(!v) v = voices.find(x => /(pt|portuguese)/i.test(x.lang)) || voices[0];
      if(v) utterance.voice = v;
      utterance.rate = arch.rate || 1;
      utterance.pitch = arch.pitch || 1;
      utterance.onstart = ()=>{ state.isSpeaking = true; updatePlayState(true) };
      utterance.onend = ()=>{ state.isSpeaking = false; updatePlayState(false) };
      synth.speak(utterance);
    });
  }

  function updatePlayState(playing){
    const spectrum = document.getElementById('spectrum');
    const status = document.getElementById('status-pill');
    const playText = document.getElementById('play-status');
    if(playing){
      spectrum.classList.add('active');
      status.innerText='TRANSMITINDO';
      status.style.background = hexToRgba(state.activeArch.colorMain, 0.2);
      status.style.color = state.activeArch.colorMain;
      status.style.boxShadow = `0 0 10px ${hexToRgba(state.activeArch.colorMain, 0.5)}`;
      playText.innerText = 'TRANSMITINDO';
      playText.style.color = state.activeArch.colorMain;
    } else {
      spectrum.classList.remove('active');
      status.innerText = 'PRONTO';
      status.style.background = 'rgba(255,255,255,0.05)';
      status.style.color = '';
      status.style.boxShadow = 'none';
      playText.innerText = 'PRONTO';
      playText.style.color = 'var(--text-muted)';
    }
  }

  // ---------- LIBRARY / DOCS ----------
  window.captureInfo = function(){
    const newDoc = {
      id: Date.now(),
      title: `${state.activeArch.name} ${state.activeArch.symbol}`,
      desc: state.activeArch.mantra,
      archId: state.activeArch.id,
      time: formatDate(),
      user: state.userName || 'Viajante'
    };
    state.docs.unshift(newDoc);
    saveState();
    flashAction();
  };

  function flashAction(){
    const card = document.querySelector('.player-card');
    if(!card) return;
    const orig = card.style.borderColor;
    card.style.borderColor = state.activeArch.colorMain;
    card.style.boxShadow = `0 0 20px ${hexToRgba(state.activeArch.colorMain, 0.4)}`;
    setTimeout(()=>{ 
      card.style.borderColor = ''; 
      card.style.boxShadow = '';
    }, 450);
    updateLibraryUI();
  }

  window.openLibrary = function(){
    const modal = document.getElementById('lib-modal');
    modal.classList.add('open');
    renderLibrary();
    renderVideos();
  }

  window.closeLibrary = function(){ document.getElementById('lib-modal').classList.remove('open'); }

  function renderLibrary(){
    const container = document.getElementById('lib-content');
    container.innerHTML = '';
    if(!state.docs || state.docs.length === 0) {
      container.innerHTML = '<div style="text-align:center;color:var(--text-muted);margin-top:30px;font-style:italic">Nenhum dado capturado.</div>';
      return;
    }
    state.docs.forEach((doc, idx)=>{
      const el = document.createElement('div');
      el.className='doc-item';
      el.innerHTML = `<div>
                        <div style="font-weight:700;color:#fff">${escapeHtml(doc.title)}</div>
                        <div class="small" style="margin-top:6px">${escapeHtml(doc.desc)}</div>
                        <div class="small" style="margin-top:8px;color:var(--text-muted);font-size:10px">${doc.time}</div>
                      </div>
                      <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
                        <button class="ghost" style="padding:4px 8px; font-size:11px" onclick="downloadDoc(${doc.id})">Baixar</button>
                        <button class="ghost" style="padding:4px 8px; font-size:11px; color:#ff5555" onclick="deleteDoc(${idx})">Apagar</button>
                      </div>`;
      container.appendChild(el);
    });
    updateLibraryUI();
  }

  window.deleteDoc = function(index){
    state.docs.splice(index,1);
    saveState();
    renderLibrary();
  }

  function updateLibraryUI(){
    document.getElementById('count-label').innerText = state.docs.length > 0 ? `${state.docs.length}` : '0';
  }

  // ---------- VIDEO HANDLER ----------
  window.openAddVideo = function(){
    const m = document.getElementById('addvideo-modal');
    m.style.display = 'flex';
    requestAnimationFrame(()=> m.classList.add('open'));
  }

  window.closeAddVideo = function(){
    const m = document.getElementById('addvideo-modal');
    m.classList.remove('open');
    setTimeout(()=> m.style.display = 'none', 300);
    document.getElementById('video-title').value='';
    document.getElementById('video-url').value='';
  }

  window.saveVideo = function(){
    const title = document.getElementById('video-title').value.trim();
    const url = document.getElementById('video-url').value.trim();
    if(!url) return alert('Cole o URL do YouTube.');
    const v = { id: Date.now(), title: title || 'Vídeo', url, time: formatDate() };
    state.videos.unshift(v);
    saveState();
    closeAddVideo();
    renderVideos();
  }

  function renderVideos(){
    const list = document.getElementById('video-list');
    list.innerHTML = '';
    if(!state.videos || state.videos.length===0) { list.innerHTML = '<div class="small" style="color:var(--text-muted)">Nenhum vídeo.</div>'; return; }
    state.videos.forEach((v, i)=>{
      const el = document.createElement('div');
      el.className='doc-item';
      el.style.borderLeftColor = '#fff';
      el.innerHTML = `<div style="max-width:65%"><div style="font-weight:700;font-size:13px">${escapeHtml(v.title)}</div><div class="small" style="margin-top:4px;color:var(--text-muted);font-size:10px">${v.time}</div></div>
                      <div style="display:flex;flex-direction:column;gap:4px">
                        <a class="ghost" style="padding:4px 8px; font-size:10px; text-align:center" href="${encodeURI(v.url)}" target="_blank" rel="noopener">Abrir</a>
                        <button class="ghost" style="padding:4px 8px; font-size:10px" onclick="generateInfoDocFromVideo(${v.id})">InfoDoc</button>
                        <button class="ghost" style="padding:4px 8px; font-size:10px; color:#ff5555" onclick="deleteVideo(${i})">X</button>
                      </div>`;
      list.appendChild(el);
    });
  }

  window.deleteVideo = function(index){
    state.videos.splice(index,1);
    saveState();
    renderVideos();
  }

  function findVideoById(id){ return state.videos.find(v=>String(v.id)===String(id)) }

  // ---------- InfoDoc generation & download ----------
  function generateInfoDoc(video){
    const arch = state.activeArch;
    const contentMd = `# InfoDoc — ${video.title || 'Vídeo'}
**Usuário:** ${state.userName || 'Viajante'}
**Data:** ${formatDate()}

## Arquétipo
- ${arch.symbol} **${arch.name}**
- **Mantra:** ${arch.mantra}
- **Sombra:** ${arch.shadow}

## Vídeo
- ${video.url}

---

Gerado pelo Dual Infodose — KOBLLUX
`;
    const contentJson = {
      meta:{ user: state.userName||'Viajante', date: new Date().toISOString() },
      video,
      arch
    };
    return { md: contentMd, json: JSON.stringify(contentJson, null, 2) };
  }

  window.generateInfoDocFromVideo = function(id){
    const v = findVideoById(id);
    if(!v) return alert('Vídeo não encontrado');
    const files = generateInfoDoc(v);
    downloadBlob(files.md, `${sanitizeFilename(v.title || 'infodoc')}.md`, 'text/markdown;charset=utf-8');
    state.docs.unshift({ id: Date.now(), title: `${state.activeArch.name} — ${v.title}`, desc: state.activeArch.mantra, time: formatDate(), source:v.url });
    saveState();
    renderLibrary();
  }

  function downloadBlob(content, filename, mime='text/plain'){
    const blob = new Blob([content], {type:mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 600);
  }

  function sanitizeFilename(name){
    return (name || 'file').replace(/[^\w\d_\-\. ]+/g,'').slice(0,120);
  }

  // Download a single doc as .md by id
  window.downloadDoc = function(id){
    const doc = state.docs.find(d=>String(d.id)===String(id));
    if(!doc) return alert('Documento não encontrado');
    downloadBlob(`# ${doc.title}\n\n${doc.desc}\n\n${doc.time}`, sanitizeFilename(doc.title)+'.md');
  }

  // Download all docs as JSON
  window.downloadAllDocs = function(){
    const pack = { user: state.userName||'Viajante', date: new Date().toISOString(), docs: state.docs, videos: state.videos };
    downloadBlob(JSON.stringify(pack,null,2), `dual_infodose_backup_${Date.now()}.json`, 'application/json');
  }

  // Export / Import session
  window.exportSession = function(){ downloadAllDocs(); }

  window.importSession = function(e){
    const f = e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = () => {
      try{
        const parsed = JSON.parse(r.result);
        if(parsed.docs) state.docs = parsed.docs;
        if(parsed.videos) state.videos = parsed.videos;
        if(parsed.user) state.userName = parsed.user;
        saveState();
        closeLibrary();
        alert('Sessão importada com sucesso.');
      }catch(err){
        alert('Arquivo inválido.');
      }
    };
    r.readAsText(f);
  }

  // ---------- ORB ----------
  window.togglePicker = function(){
    pickerOpen = !pickerOpen;
    const fab = document.getElementById('fab');
    if(pickerOpen) fab.classList.add('open'); else fab.classList.remove('open');
  }

  // ---------- PROFILE ----------
  window.saveProfile = function(){
    const name = document.getElementById('profile-name').value.trim();
    const assistant = document.getElementById('profile-assistant').value.trim();
    if(!name) return alert('Preencha seu nome.');
    state.userName = name;
    state.assistantName = assistant;
    saveState();
    document.getElementById('user-welcome').innerText = `AGENTE: ${state.userName}`;
    shortBeep("Protocolo Aceito");
    // visual feedback
    const btn = document.querySelector('.primary');
    btn.innerText = 'Ativado!';
    setTimeout(()=>btn.innerText='Ativar', 1500);
  }

  window.clearProfile = function(){
    if(!confirm('Limpar perfil?')) return;
    state.userName = '';
    state.assistantName = '';
    localStorage.removeItem(STORAGE_KEYS.user);
    localStorage.removeItem(STORAGE_KEYS.assistant);
    document.getElementById('profile-name').value = '';
    document.getElementById('profile-assistant').value = '';
    document.getElementById('user-welcome').innerText = `Bem-vindo`;
    updateLibraryUI();
  }

  // ---------- LIVE CARDS (smaller view) ----------
  function renderLiveCards(){
    const container = document.getElementById('live-cards');
    container.innerHTML = '';
    if(!state.docs || state.docs.length===0){
      container.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:var(--text-muted);padding:12px; font-style:italic">Vazio.</div>';
      return;
    }
    state.docs.slice(0,6).forEach(doc => {
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `<div><h3 style="font-size:14px">${escapeHtml(doc.title)}</h3><p style="margin-top:6px">${escapeHtml(doc.desc)}</p></div><div class="small" style="font-size:10px; margin-top:auto; padding-top:8px">${doc.time}</div>`;
      container.appendChild(div);
    });
    updateLibraryUI();
    updateLiveCardsHighlight();
  }

  function updateLiveCardsHighlight(){
    const cards = document.querySelectorAll('#live-cards .card');
    cards.forEach(c => c.style.borderColor = 'var(--glass-border)');
    if(cards[0]) cards[0].style.borderColor = state.activeArch.colorMain;
  }

  // ---------- UTIL ----------
  function escapeHtml(unsafe) {
    if(!unsafe && unsafe !== 0) return '';
    return String(unsafe)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  // ---------- PWA: beforeinstallprompt ----------
  window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault();
    deferredPrompt = e;
    document.getElementById('prompt-install').style.display = 'inline-block';
  });

  window.promptInstall = async function(){
    if(!deferredPrompt) return;
    deferredPrompt.prompt();
    const choice = await deferredPrompt.userChoice;
    if(choice.outcome === 'accepted') {
      deferredPrompt = null;
      document.getElementById('prompt-install').style.display='none';
    }
  }

  // ---------- Service Worker registration ----------
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js').then(reg=>{
      console.log('SW registrado', reg);
    }).catch(err=>console.warn('SW erro', err));
  }

  // ---------- SPLASH / BOOT ----------
  window.initSystem = function(){
    const name = document.getElementById('splash-name').value.trim();
    state.userName = name || state.userName || 'Viajante';
    localStorage.setItem(STORAGE_KEYS.user, state.userName);
    document.getElementById('profile-name').value = state.userName;
    document.getElementById('user-welcome').innerText = `Agente: ${state.userName}`;
    
    // Animação de saída
    const splash = document.getElementById('splash-screen');
    splash.style.opacity = '0';
    setTimeout(()=>{
        splash.classList.add('hidden');
        document.querySelector('.shell').classList.add('visible');
    }, 800);

    // unlock TTS
    const welcome = `Sistema KOBLLUX online. Bem-vindo, ${state.userName}.`;
    const u = new SpeechSynthesisUtterance(welcome);
    u.lang = 'pt-BR';
    ensureVoices((voices)=>{ if(voices[0]) u.voice = voices[0]; synth.speak(u); });
  };

  // Clock
  setInterval(()=>{ document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) }, 1000);

  // ---------- SESSION IMPORT helper ----------
  window.importSessionFromInput = function(ev){
    importSession(ev);
  }

  // ---------- INITIALIZE UI ----------
  function initUI(){
    buildPicker();
    applyTheme(state.activeArch);
    renderLiveCards();
    renderVideos();
    updateLibraryUI();
    if(state.userName) document.getElementById('profile-name').value = state.userName;
    if(state.assistantName) document.getElementById('profile-assistant').value = state.assistantName;
    document.getElementById('lib-modal').classList.remove('open');
    document.getElementById('addvideo-modal').classList.remove('open');
    window.downloadAllDocs = downloadAllDocs;
  }

  function saveState(){ saveStateInner(); }
  function saveStateInner(){
    localStorage.setItem(STORAGE_KEYS.docs, JSON.stringify(state.docs));
    localStorage.setItem(STORAGE_KEYS.videos, JSON.stringify(state.videos));
    localStorage.setItem(STORAGE_KEYS.user, state.userName);
    localStorage.setItem(STORAGE_KEYS.assistant, state.assistantName);
    renderLibrary();
    renderVideos();
    renderLiveCards();
    updateLibraryUI();
  }

  window._dual_state = state;
  initUI();

})();
</script>
</body>
</html>
