<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>DUAL // FUSION — Recursive Fractal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#030406">

  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#030406">
  <link rel="apple-touch-icon" href="./icon-192.png">

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .catch(err => console.error('SW Error:', err));
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

  <style>
    :root {
      --bg-deep: #030406;
      --glass-surface: rgba(20, 20, 25, 0.75);
      --glass-border: rgba(255, 255, 255, 0.08);
      --neon-cyan: #00f2ff;
      --neon-purple: #bd00ff;
      --ease-elastic: cubic-bezier(0.34, 1.3, 0.64, 1);
      --ease-smooth: cubic-bezier(0.23, 1, 0.32, 1);
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0; padding: 0;
      min-height: 100vh;
      background-color: var(--bg-deep);
      color: #fff;
      font-family: 'Montserrat', sans-serif;
      overflow-x: hidden; /* Previne scroll lateral no mobile */
      overflow-y: auto;   /* Scroll vertical nativo */
      display: flex; justify-content: center; align-items: center;
      background-image: radial-gradient(circle at 50% 50%, rgba(20,20,30,1) 0%, rgba(3,4,6,1) 100%);
    }

    /* Ambient Blobs */
    .blob { position: fixed; border-radius: 50%; filter: blur(90px); opacity: 0.15; z-index: -1; animation: float 20s infinite alternate; }
    .b1 { width: 300px; height: 300px; background: var(--neon-cyan); top: -50px; left: -50px; }
    .b2 { width: 350px; height: 350px; background: var(--neon-purple); bottom: -50px; right: -50px; animation-delay: -5s; }
    @keyframes float { 0% { transform: translate(0,0); } 100% { transform: translate(30px,50px); } }

    /* CONTAINER PRINCIPAL */
    .container {
      width: 100%;
      min-height: 100vh; /* Garante altura para alinhar */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px 10px; /* Padding lateral seguro para mobile */
    }

    /* O PAI (Card Principal) */
    .fusion-card {
      position: relative;
      background: var(--glass-surface);
      backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
      border: 1px solid var(--glass-border);
      box-shadow: 0 30px 80px rgba(0,0,0,0.6);
      border-radius: 32px;
      
      /* Morph States */
      width: 280px;
      padding: 20px;
      transform: scale(0.98);
      opacity: 0;
      transition: width 0.5s var(--ease-elastic), padding 0.5s var(--ease-smooth), border-radius 0.5s, transform 0.5s;
      
      display: flex; flex-direction: column; gap: 15px;
      overflow: hidden; /* Mantém o conteúdo contido na animação */
    }

    .fusion-card.active { opacity: 1; transform: scale(1); }

    /* Estado Aberto (Expandido) */
    .fusion-card.open {
      width: 100%;
      max-width: 460px; /* Largura máxima desktop */
      padding: 30px;
      border-radius: 40px;
    }

    /* Mobile Fix: Quando aberto no celular, ocupa quase tudo */
    @media (max-width: 480px) {
      .fusion-card.open { width: 95%; padding: 25px 20px; }
    }

    /* Header (Sempre visível) */
    .card-header { display: flex; align-items: center; gap: 15px; cursor: pointer; user-select: none; }
    .avatar-ring { 
      width: 54px; height: 54px; border-radius: 50%; 
      background: conic-gradient(from 0deg, var(--neon-cyan), var(--neon-purple), var(--neon-cyan));
      padding: 2px; position: relative;
    }
    .avatar-inner { width: 100%; height: 100%; background: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .avatar-img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
    
    .header-info { display: flex; flex-direction: column; flex: 1; }
    .brand { font-size: 1.6rem; font-weight: 800; letter-spacing: -1px; background: linear-gradient(to right, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .status { font-size: 0.7rem; color: var(--neon-cyan); letter-spacing: 2px; text-transform: uppercase; font-family: 'JetBrains Mono', monospace; }

    /* O FILHO (Blocos Recursivos) */
    /* Esta classe faz os blocos internos parecerem mini-versões do card pai */
    .recursive-block {
      background: rgba(0,0,0,0.3); /* Um pouco mais escuro para profundidade */
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 20px;
      padding: 15px;
      opacity: 0; transform: translateY(10px); /* Stagger init */
      transition: all 0.4s var(--ease-smooth);
      display: none; /* Escondido quando fechado */
    }

    .fusion-card.open .recursive-block { display: flex; flex-direction: column; gap: 10px; }
    /* Animação de entrada */
    .fusion-card.open .recursive-block.show { opacity: 1; transform: translateY(0); }

    /* Stagger Delays */
    .recursive-block:nth-child(2) { transition-delay: 0.1s; }
    .recursive-block:nth-child(3) { transition-delay: 0.2s; }
    .recursive-block:nth-child(4) { transition-delay: 0.3s; }

    /* Inputs e Controles Minimalistas */
    .cyber-input {
      width: 100%; background: transparent; border: none; border-bottom: 1px solid rgba(255,255,255,0.2);
      padding: 8px 0; color: #fff; font-family: 'JetBrains Mono'; font-size: 0.9rem;
      transition: 0.3s;
    }
    .cyber-input:focus { border-bottom-color: var(--neon-cyan); }

    /* Botões de Ícone (Minimal) */
    .action-row { display: flex; gap: 10px; margin-top: 5px; }
    .icon-btn {
      flex: 1; height: 44px;
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05);
      border-radius: 12px; color: rgba(255,255,255,0.7);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: 0.2s;
    }
    .icon-btn:hover { background: rgba(255,255,255,0.1); color: #fff; border-color: rgba(255,255,255,0.2); }
    .icon-btn.primary { background: rgba(0, 242, 255, 0.1); border-color: rgba(0, 242, 255, 0.3); color: var(--neon-cyan); }
    
    /* Área de Ativação ASCII Minimal */
    .ascii-box {
      font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: rgba(255,255,255,0.6);
      white-space: pre; overflow-x: hidden; line-height: 1.2;
      opacity: 0.7;
    }

    /* O ESPÍRITO (Overlay Imersivo / Lime-Style) */
    #immersiveLayer {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(5, 5, 8, 0.96); /* Quase sólido */
      backdrop-filter: blur(20px);
      z-index: 999;
      display: flex; flex-direction: column;
      opacity: 0; pointer-events: none;
      transition: opacity 0.4s ease;
    }
    #immersiveLayer.active { opacity: 1; pointer-events: all; }

    .immersive-header {
      height: 60px; display: flex; align-items: center; justify-content: space-between;
      padding: 0 20px; border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .immersive-content {
      flex: 1; width: 100%; height: 100%; border: none; display: block;
      background: transparent;
    }
    .close-immersive {
      background: transparent; border: 1px solid rgba(255,50,50,0.3); color: #ff5555;
      padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; cursor: pointer;
      font-family: 'JetBrains Mono'; text-transform: uppercase;
    }
    .close-immersive:hover { background: rgba(255,0,0,0.1); }

  </style>
</head>
<body>

  <div class="blob b1"></div>
  <div class="blob b2"></div>

  <div id="immersiveLayer">
    <div class="immersive-header">
      <span style="font-family:'JetBrains Mono';font-size:0.8rem;color:var(--neon-cyan)">// MÓDULO VISUALIZADOR</span>
      <button class="close-immersive" onclick="closeImmersive()">FECHAR CONEXÃO</button>
    </div>
    <div id="immersiveContainer" style="width:100%;height:100%;overflow:hidden"></div>
  </div>

  <div class="container">
    
    <div class="fusion-card" id="mainCard">
      
      <div class="card-header" onclick="toggleCard()">
        <div class="avatar-ring">
          <div class="avatar-inner">
             <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5" /></svg>
          </div>
        </div>
        <div class="header-info">
          <div class="brand">DUAL // FUSION</div>
          <div class="status" id="statusText">AGUARDANDO</div>
        </div>
        <div id="chevron" style="opacity:0.5; transition:0.3s"><i data-lucide="chevron-down"></i></div>
      </div>

      <div class="recursive-block">
        <div style="font-size:0.7rem; text-transform:uppercase; color:rgba(255,255,255,0.4); margin-bottom:5px">Identificação</div>
        <input type="text" class="cyber-input" id="userInput" placeholder="Quem está no comando?" autocomplete="off">
      </div>

      <div class="recursive-block">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
          <span style="font-size:0.7rem; text-transform:uppercase; color:rgba(255,255,255,0.4)">Assinatura Digital</span>
          <span style="font-size:0.6rem; color:var(--neon-purple)" id="versionBadge">v.369</span>
        </div>
        <div class="ascii-box" id="asciiTarget">
+----------------+
| SYSTEM: READY  |
+----------------+
        </div>
        <div class="action-row">
          <button class="icon-btn" onclick="copyAscii()" title="Copiar"><i data-lucide="copy" size="16"></i></button>
          <button class="icon-btn" onclick="shareAscii()" title="Share"><i data-lucide="share-2" size="16"></i></button>
        </div>
      </div>

      <div class="recursive-block">
        <div style="font-size:0.7rem; text-transform:uppercase; color:rgba(255,255,255,0.4); margin-bottom:5px">Injeção de Código</div>
        
        <input type="file" id="fileInput" style="display:none" accept=".html,.htm,.txt">
        
        <div class="action-row">
          <button class="icon-btn" onclick="document.getElementById('fileInput').click()" title="Carregar Arquivo">
            <i data-lucide="upload-cloud" size="18"></i>
          </button>
          
          <button class="icon-btn primary" id="injectBtn" title="Executar Imersão" disabled>
            <i data-lucide="play" size="18"></i>
          </button>
        </div>
        <div id="fileName" style="font-size:0.65rem; color:rgba(255,255,255,0.3); text-align:center; margin-top:5px; min-height:1em"></div>
      </div>

    </div>
  </div>

  <script>
    // Inicialização
    lucide.createIcons();
    const card = document.getElementById('mainCard');
    const chevron = document.getElementById('chevron');
    const statusText = document.getElementById('statusText');
    const userInput = document.getElementById('userInput');
    const asciiTarget = document.getElementById('asciiTarget');
    
    // Animação de Entrada
    setTimeout(() => card.classList.add('active'), 100);

    // Lógica Morph (Pai abrindo para os Filhos)
    function toggleCard() {
      const isOpen = card.classList.contains('open');
      const blocks = document.querySelectorAll('.recursive-block');

      if (isOpen) {
        // Fechar
        card.classList.remove('open');
        chevron.style.transform = 'rotate(0deg)';
        statusText.innerText = 'AGUARDANDO';
        statusText.style.color = 'var(--neon-cyan)';
        
        // Esconde os filhos
        blocks.forEach(b => b.classList.remove('show'));
      } else {
        // Abrir
        card.classList.add('open');
        chevron.style.transform = 'rotate(180deg)';
        statusText.innerText = 'SINTONIZADO';
        statusText.style.color = 'var(--neon-purple)';
        
        // Revela os filhos em cascata
        setTimeout(() => {
          blocks.forEach(b => b.classList.add('show'));
        }, 200);
      }
    }

    // ASCII Reativo (Simples)
    userInput.addEventListener('input', (e) => {
      const val = e.target.value.toUpperCase() || 'UNKNOWN';
      asciiTarget.innerText = `
+----------------+
| USER: ${val.padEnd(8).slice(0,8)} |
| SYNC: 3-6-9    |
+----------------+`;
    });

    function copyAscii() {
      navigator.clipboard.writeText(asciiTarget.innerText);
      statusText.innerText = 'COPIADO';
      setTimeout(() => statusText.innerText = 'SINTONIZADO', 1000);
    }

    // --- LÓGICA DE INJEÇÃO (Lime-Style / Imersivo) ---
    
    let loadedContent = null;
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');
    const injectBtn = document.getElementById('injectBtn');
    const immersiveLayer = document.getElementById('immersiveLayer');
    const immersiveContainer = document.getElementById('immersiveContainer');

    // 1. Carregar Arquivo
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      fileName.innerText = `BUFFER: ${file.name}`;
      const reader = new FileReader();
      reader.onload = (ev) => {
        loadedContent = ev.target.result;
        injectBtn.disabled = false;
        injectBtn.style.opacity = '1';
        statusText.innerText = 'BUFFER PRONTO';
      };
      reader.readAsText(file);
    });

    // 2. Injetar (Ativar o Espírito)
    injectBtn.addEventListener('click', () => {
      if (!loadedContent) return;

      // Limpa container anterior
      immersiveContainer.innerHTML = '';

      // Cria iframe full screen (Sandbox)
      const iframe = document.createElement('iframe');
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      iframe.style.border = 'none';
      // Permite scripts para o módulo funcionar, mas segura o resto
      iframe.sandbox = "allow-scripts allow-same-origin allow-forms"; 
      
      // Sanitização básica (opcional, remova DOMPurify se quiser RAW total)
      // iframe.srcdoc = DOMPurify.sanitize(loadedContent); 
      iframe.srcdoc = loadedContent; // Modo RAW (Lime-style, sem frescura)

      immersiveContainer.appendChild(iframe);

      // Fade In Overlay
      immersiveLayer.classList.add('active');
    });

    // 3. Fechar Imersão
    window.closeImmersive = function() {
      immersiveLayer.classList.remove('active');
      setTimeout(() => {
        immersiveContainer.innerHTML = ''; // Limpa memória visual
      }, 400);
    }

  </script>
</body>
</html>
